#!/usr/bin/env node
const path = require('path')
const yargs = require('yargs')
const inquirer = require('inquirer')
const { runScript } = require('../run-script')
const { Options } = require('../options')
let configPath = path.join(path.resolve('./'), 'packages.config.js')
if (yargs.argv.c || yargs.argv.config) {
  configPath = path.join(process.cwd(), yargs.argv.c || yargs.argv.config)
}
const config = require(configPath)

void async function main() {
  console.clear()

  if (yargs.argv._.length !== 0) {
    const scripts = yargs.argv._
    for (const script of scripts) {
      console.log(script)
      await runScript(config.packages, script)
    }
    process.exit()
  }

  const result = await inquirer.prompt([
    { 
      type: 'list', 
      name: 'default-action', 
      message: 'Please select an action', 
      choices: [
        ...config.defaultActions.map(action => ({ name: action.name, value: action })),
        { name: ' ', value: '[[manual-selection]]' },
        { name: 'Manual Selection', value: '[[manual-selection]]' },
      ]
    }
  ])

  console.clear()
  if (result['default-action'] !== '[[manual-selection]]') {
    const options = {}
    if (result['default-action'].options?.includes(Options.NoPrefix)) {
      options.prefix = 'none'
    }
    for (const script of result['default-action'].commands) {
      await runScript(config.packages, script, options)
    }
    process.exit(0)
  }

  const manualResult = await inquirer
    .prompt([
      {
        type: 'checkbox', 
        name: 'selected-packages', 
        message: 'What packages do you want to run?', 
        choices: config.packages.map(pkg => ({ name: pkg.name }))
      },
      {
        type: 'input',
        name: 'run-scripts',
        message: 'What scripts do you want to run?'
      }
    ])

  for (const script of manualResult['run-scripts'].split(' ')) {
    await runScript(selectPackages(manualResult['selected-packages']), script)
  }
}()


const selectPackages = (pkgArr) => {
  const getDependencies = (pkg, pkgs = {}) => {
    pkgs[pkg.name] = pkg
    for (const dep of pkg.dependsOn) {
      pkgs[dep.name] = dep
      getDependencies(dep, pkgs)
    }
    return Object.values(pkgs)
  }

  const selectedPackages = {}
  
  pkgArr
    .map(pkgName => config.packages.find(pkg => pkg.name === pkgName))
    .forEach(pkg => getDependencies(pkg, selectedPackages))

  return Object.values(selectedPackages)
}
